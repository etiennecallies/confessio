{% extends 'layouts/single_card.html' %}

{% block card %}
    <h2 class="mb-3">
        Website: {{ website_moderation.get_category_display }}
    </h2>
    {% if website_moderation.bug_description %}
        <p>Bug description : {{ website_moderation.bug_description }}</p>
    {% endif %}
    <p><a class="btn btn-primary" href="{% url 'admin:home_website_change' website.uuid %}" target="_blank" role="button">
        Open admin <i class="fas fa-up-right-from-square"></i>
    </a></p>
    <p>Name : {{ website_moderation.name }}</p>
    {% if website.name != website_moderation.name %}
        <p>New name : {{ website.name }}</p>
    {% endif %}
    <p>Home url : <a href="{{ website_moderation.home_url }}" target="_blank">{{ website_moderation.home_url }}</a></p>
    {% if website.home_url != website_moderation.home_url %}
        <p>New home url : <a href="{{ website.home_url }}" target="_blank">{{ website.home_url }}</a></p>
    {% endif %}
    {% if website_moderation.other_parish %}
        <p>Conflicting with website {{ website_moderation.other_parish.name }}
            <a class="btn btn-primary" href="{% url 'admin:home_website_change' website_moderation.other_parish.uuid %}" target="_blank" role="button">
        Open admin <i class="fas fa-up-right-from-square"></i>
    </a></p>
    {% endif %}
    {% if latest_crawling %}
        <h3>Latest crawling</h3>
        <p>Date : {{ latest_crawling.created_at }}</p>
        <p>Nb visited links : {{ latest_crawling.nb_visited_links }}</p>
        <p>Nb success links : {{ latest_crawling.nb_success_links }}</p>
        <p>Error detail : {{ latest_crawling.error_detail }}</p>
    {% endif %}
    <h3>Sources & Churches</h3>
    {% for parish_source in website.sources.all %}
        <h4>{{ parish_source.name }} ({{ parish_source.messesinfo_community_id }})</h4>
        {% for church in parish_source.churches.all %}
            <h5>{{ church.name }} ({{ church.messesinfo_id }})</h5>
            <p>City : {{ church.city }}
                <a class="btn btn-primary" href="{% url 'admin:home_church_change' church.uuid %}" target="_blank" role="button">
                    Open admin <i class="fas fa-up-right-from-square"></i>
                </a>
            </p>
        {% endfor %}
    {% endfor %}
    {% if website_moderation.other_parish %}
        <h3>Sources & Churches of {{ website_moderation.other_parish.name }}</h3>
        {% for parish_source in website_moderation.other_parish.sources.all %}
            <h4>{{ parish_source.name }} ({{ parish_source.messesinfo_community_id }})</h4>
            {% for church in parish_source.churches.all %}
                <h5>{{ church.name }} ({{ church.messesinfo_id }})</h5>
                <p>City : {{ church.city }}
                    <a class="btn btn-primary" href="{% url 'admin:home_church_change' church.uuid %}" target="_blank" role="button">
                        Open admin <i class="fas fa-up-right-from-square"></i>
                    </a>
                </p>
            {% endfor %}
        {% endfor %}
    {% endif %}

    <h3>Parish sources</h3>
    {% for source in website.sources.all %}
        <h5>{{ source.name }}</h5>
        <p>{{ source.messesinfo_community_id }}
            <a class="btn btn-primary" href="{% url 'admin:home_parishsource_change' source.uuid %}" target="_blank" role="button">
                Open admin <i class="fas fa-up-right-from-square"></i>
            </a>
        </p>
    {% endfor %}
    {% if website_moderation.other_parish %}
        <h3>Parish sources of {{ website_moderation.other_parish.name }}</h3>
        {% for source in website_moderation.other_parish.sources.all %}
            <h5>{{ source.name }}</h5>
            <p>{{ source.messesinfo_community_id }}
                <a class="btn btn-primary" href="{% url 'admin:home_parishsource_change' source.uuid %}" target="_blank" role="button">
                    Open admin <i class="fas fa-up-right-from-square"></i>
                </a>
            </p>
        {% endfor %}
    {% endif %}

    {% if website_moderation.other_parish %}
        <div>
            <form action="{% url 'moderate_merge_websites' website_moderation.uuid %}" method="post">
                {% csrf_token %}
            <button type="submit" class="btn btn-warning">Merge Websites</button>
            </form>
        </div>
    {% endif %}

    <div>
        <div class="d-inline-block">
            <form method="post">
            {% csrf_token %}
            <button type="submit" class="btn btn-primary">Validate & next</button>
            </form>
        </div>
        <div class="d-inline-block">
            <a class="btn btn-info" role="button" href="{{ next_url }}">Next</a>
        </div>
    </div>
    {% if not website_moderation.marked_as_bug_at %}
        <div>
            <form method="post">
                <label>
                    <input type="text" name="bug_description" maxlength="{{ bug_description_max_length }}">
                </label>
                {% csrf_token %}
            <button type="submit" class="btn btn-danger">Report bug & next</button>
            </form>
        </div>
    {% endif %}
{% endblock card %}