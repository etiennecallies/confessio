##
# Configure nginx web server
##
- name: install nginx
  apt: name=nginx state=latest
  become: yes

- name: install letsencrypt
  apt: name=letsencrypt state=latest

- name: Write nginx conf file
  template: src=confessio.conf dest=/etc/nginx/conf.d/{{ app_name }}.conf
  become: yes
  notify:
    - restart nginx

- name: create letsencrypt directory
  file: name=/var/www/letsencrypt state=directory

- name: Create letsencrypt certificate
  shell: letsencrypt certonly -n --webroot -w /var/www/letsencrypt -m {{ letsencrypt_email }} --agree-tos -d {{ server_host }}
  args:
    creates: /etc/letsencrypt/live/{{ server_host }}
  notify:
    - restart nginx

- name: Add letsencrypt cronjob for cert renewal
  cron:
    name: letsencrypt_renewal
    special_time: weekly
    job: letsencrypt --renew certonly -n --webroot -w /var/www/letsencrypt -m {{ letsencrypt_email }} --agree-tos -d {{ server_host }} && service nginx reload
